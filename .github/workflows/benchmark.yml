name: Benchmark Regression Analysis

on:
    workflow_dispatch:
        inputs:
            target_ref:
                description: 'SHA commit to benchmark.'
                required: false
                default: ''
                type: string
            
            benchmark_type:
                description: 'Type of benchmark to run'
                required: true
                default: 'full'
                type: choice
                options:
                    - 'full'
                    #later add functionalities for functionwise benchmarking results
            
            fail_on_regression:
                description: 'Fail the workflow if regressions are detected'
                required: false
                default: true
                type: boolean
            
            regression_threshold:
                description: 'Regression threshold percentage (e.g., 10 for 10%)'
                required: false
                default: '10'
                type: string
            
    pull_request:
        branches:
            - master

jobs:
  benchmark-regression:
    runs-on: ubuntu-latest
    
    #steps:
    # - name: Determine target reference
    #   id: target-ref
    #   run: |
    #     if [ -n "${{ github.event.inputs.target_ref }}" ]; then
    #       echo "ref=${{ github.event.inputs.target_ref }}" >> $GITHUB_OUTPUT
    #       echo "Benchmarking specified reference: ${{ github.event.inputs.target_ref }}"
    #     else
    #       echo "ref=${{ github.sha }}" >> $GITHUB_OUTPUT
    #       echo "Benchmarking current commit: ${{ github.sha }}"
    #     fi

    steps:
    - name: Set default values for all trigger types
      id: defaults
      run: |

        echo "benchmark_type=${{ github.event.inputs.benchmark_type || 'full' }}" >> $GITHUB_OUTPUT
        echo "fail_on_regression=${{ github.event.inputs.fail_on_regression || 'true' }}" >> $GITHUB_OUTPUT  
        echo "regression_threshold=${{ github.event.inputs.regression_threshold || '10' }}" >> $GITHUB_OUTPUT
        

        if [ -n "${{ github.event.inputs.target_ref }}" ]; then
          echo "target_ref=${{ github.event.inputs.target_ref }}" >> $GITHUB_OUTPUT
          echo "üìç Using specified reference: ${{ github.event.inputs.target_ref }}"
        else
          echo "target_ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "üìç Using current commit: ${{ github.sha }}"
        fi
        
        # Log the trigger type for debugging
        echo "üîß Workflow triggered by: ${{ github.event_name }}"


    
    - name: Checkout toqito repository at the current/mentioned commit
      uses: actions/checkout@v4
      with:
        path: toqito
        ref: ${{ steps.defaults.outputs.target_ref }}
        fetch-depth: 0
    
    - name: Display benchmark target info
      run: |
        cd toqito
        echo "  BENCHMARK TARGET INFORMATION"
        echo "================================"
        echo "Repository: vprusso/toqito"
        echo "Reference: ${{ steps.defaults.outputs.target_ref }}"
        echo "Commit SHA: $(git rev-parse HEAD)"
        echo "Commit Message: $(git log -1 --pretty=format:'%s')"
        echo "Author: $(git log -1 --pretty=format:'%an <%ae>')"
        echo "Date: $(git log -1 --pretty=format:'%ad')"
        echo "Benchmark Type: ${{  steps.defaults.outputs.benchmark_type }}"
        echo "Regression Threshold: ${{ steps.defaults.outputs.regression_threshold }}%"
        echo "Fail on Regression: ${{ steps.defaults.outputs.fail_on_regression  }}"
        echo "Triggered by: ${{ github.event_name }}"
        echo "================================"